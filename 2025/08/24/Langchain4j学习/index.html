<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Langchain4j学习 | Journey</title><meta name="author" content="ldy"><meta name="copyright" content="ldy"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="一、快速入门普通maven项目1.创建maven工程2.引入依赖123456&lt;!-- 这个依赖额外提供 OpenAI 模型调用能力 --&gt;&lt;dependency&gt;  &lt;groupId&gt;dev.langchain4j&lt;&#x2F;groupId&gt;  &lt;artifactId&gt;langchain4j-open-ai&lt;&#x2F;artifactId&gt;">
<meta property="og:type" content="article">
<meta property="og:title" content="Langchain4j学习">
<meta property="og:url" content="http://example.com/2025/08/24/Langchain4j%E5%AD%A6%E4%B9%A0/index.html">
<meta property="og:site_name" content="Journey">
<meta property="og:description" content="一、快速入门普通maven项目1.创建maven工程2.引入依赖123456&lt;!-- 这个依赖额外提供 OpenAI 模型调用能力 --&gt;&lt;dependency&gt;  &lt;groupId&gt;dev.langchain4j&lt;&#x2F;groupId&gt;  &lt;artifactId&gt;langchain4j-open-ai&lt;&#x2F;artifactId&gt;">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/qcqwy/blog-img@main/img/poke1.png">
<meta property="article:published_time" content="2025-08-24T11:47:55.000Z">
<meta property="article:modified_time" content="2025-08-24T15:52:59.545Z">
<meta property="article:author" content="ldy">
<meta property="article:tag" content="大模型">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/qcqwy/blog-img@main/img/poke1.png"><link rel="shortcut icon" href="/img/logo2.jpeg"><link rel="canonical" href="http://example.com/2025/08/24/Langchain4j%E5%AD%A6%E4%B9%A0/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta/><link rel="stylesheet" href="/css/index.css?v=4.13.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体中文","cht_to_chs":"你已切换为简体中文","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"bottom-left"},
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.1/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Langchain4j学习',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-08-24 23:52:59'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.2.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://cdn.jsdelivr.net/gh/qcqwy/blog-img@main/img/poke1.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">35</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">26</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">10</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 列表</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友情链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://t.alcy.cc/fj/')"><nav id="nav"><span id="blog-info"><a href="/" title="Journey"><img class="site-icon" src="/img/logo.jpeg"/><span class="site-name">Journey</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 列表</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友情链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Langchain4j学习</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-08-24T11:47:55.000Z" title="发表于 2025-08-24 19:47:55">2025-08-24</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-08-24T15:52:59.545Z" title="更新于 2025-08-24 23:52:59">2025-08-24</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/java/">java</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Langchain4j学习"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="一、快速入门"><a href="#一、快速入门" class="headerlink" title="一、快速入门"></a>一、快速入门</h2><h3 id="普通maven项目"><a href="#普通maven项目" class="headerlink" title="普通maven项目"></a>普通maven项目</h3><h4 id="1-创建maven工程"><a href="#1-创建maven工程" class="headerlink" title="1.创建maven工程"></a>1.创建maven工程</h4><h4 id="2-引入依赖"><a href="#2-引入依赖" class="headerlink" title="2.引入依赖"></a>2.引入依赖</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 这个依赖额外提供 OpenAI 模型调用能力 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>dev.langchain4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>langchain4j-open-ai<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="3-构建聊天对象OpenAiChatModel"><a href="#3-构建聊天对象OpenAiChatModel" class="headerlink" title="3.构建聊天对象OpenAiChatModel"></a>3.构建聊天对象OpenAiChatModel</h4><p>因为Deepseek使用与OpenAi兼容的API格式，所以这里我创建了连接DeepSeek的模型</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">App</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">//1.构建openAiChatModel对象</span></span><br><span class="line">        <span class="type">OpenAiChatModel</span> <span class="variable">model</span> <span class="operator">=</span> OpenAiChatModel.builder()</span><br><span class="line">                .baseUrl(<span class="string">&quot;https://api.deepseek.com&quot;</span>) <span class="comment">//模型的url</span></span><br><span class="line">                .modelName(<span class="string">&quot;deepseek-chat&quot;</span>) <span class="comment">//模型的名称</span></span><br><span class="line">                .apiKey(<span class="string">&quot;&quot;</span>) <span class="comment">//自己获取的apikey</span></span><br><span class="line">                .logRequests(<span class="literal">true</span>) <span class="comment">//打印请求日志</span></span><br><span class="line">                .logResponses(<span class="literal">true</span>) <span class="comment">//打印响应日志</span></span><br><span class="line">                .build();</span><br><span class="line">        <span class="comment">//2.调用chat方法</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">res</span> <span class="operator">=</span> model.chat(<span class="string">&quot;你好啊&quot;</span>);</span><br><span class="line">        System.out.println(res);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="测试结果"><a href="#测试结果" class="headerlink" title="测试结果"></a>测试结果</h4><p><img src="/images/image-20250824200254269.png" alt="image-20250824200254269"></p>
<h3 id="Spring整合Langchain4j"><a href="#Spring整合Langchain4j" class="headerlink" title="Spring整合Langchain4j"></a>Spring整合Langchain4j</h3><p>springboot项目创建看之前的博客。</p>
<h4 id="1-核心依赖"><a href="#1-核心依赖" class="headerlink" title="1.核心依赖"></a>1.核心依赖</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--        langchain4j的springboot启动依赖--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>dev.langchain4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>langchain4j-open-ai-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.1-beta6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="2-在配置文件中配置大模型信息"><a href="#2-在配置文件中配置大模型信息" class="headerlink" title="2.在配置文件中配置大模型信息"></a>2.在配置文件中配置大模型信息</h4><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">langchain4j:</span></span><br><span class="line">  <span class="attr">open-ai:</span></span><br><span class="line">    <span class="attr">chat-model:</span> <span class="comment">#普通模型</span></span><br><span class="line">      <span class="attr">base-url:</span> <span class="string">https://api.deepseek.com</span></span><br><span class="line">      <span class="attr">model-name:</span> <span class="string">deepseek-chat</span></span><br><span class="line">      <span class="attr">api-key:</span> <span class="string">自己的apikey</span></span><br><span class="line">      <span class="attr">log-requests:</span> <span class="literal">true</span>   <span class="comment"># 打印请求日志</span></span><br><span class="line">      <span class="attr">log-responses:</span> <span class="literal">true</span>   <span class="comment"># 打印响应日志</span></span><br><span class="line">    <span class="attr">streaming-chat-model:</span> <span class="comment">#流式模型</span></span><br><span class="line">      <span class="attr">base-url:</span> <span class="string">https://api.deepseek.com</span></span><br><span class="line">      <span class="attr">model-name:</span> <span class="string">deepseek-chat</span></span><br><span class="line">      <span class="attr">api-key:</span> <span class="string">自己的apikey</span></span><br><span class="line">      <span class="attr">log-requests:</span> <span class="literal">true</span>   <span class="comment"># 打印请求日志</span></span><br><span class="line">      <span class="attr">log-responses:</span> <span class="literal">true</span>   <span class="comment"># 打印响应日志</span></span><br></pre></td></tr></table></figure>

<h4 id="3-创建Controller调用接口"><a href="#3-创建Controller调用接口" class="headerlink" title="3.创建Controller调用接口"></a>3.创建Controller调用接口</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;chat&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ChatController</span> &#123;</span><br><span class="line">    <span class="comment">//引入自动装配好的model</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    OpenAiChatModel chatModel;</span><br><span class="line">    <span class="meta">@GetMapping</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">get</span><span class="params">(String msg)</span>&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">chat</span> <span class="operator">=</span> chatModel.chat(msg);</span><br><span class="line">        <span class="keyword">return</span> chat;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="测试结果-1"><a href="#测试结果-1" class="headerlink" title="测试结果"></a>测试结果</h4><p><img src="/images/image-20250824201201790.png" alt="image-20250824201201790"></p>
<p>综上，最简单的与大模型的交互就完成了。</p>
<h2 id="二、进阶篇"><a href="#二、进阶篇" class="headerlink" title="二、进阶篇"></a>二、进阶篇</h2><h3 id="1-AiService工具类"><a href="#1-AiService工具类" class="headerlink" title="1.AiService工具类"></a>1.AiService工具类</h3><p>LangChain4j提供的工具类AiServices，是一个非常宝藏的工具。在快速入门中，访问大模型是借助于OpenAiChatModel的chat方法完成的。其实这种方式在实际开发中并不是很常用，因为如果使用这种方式调用大模型，将来我们完成一些高阶的功能，比如<strong>会话记忆&#x2F;RAG知识库&#x2F;Tools工具</strong>的时候，在调用chat方法访问大模型前，我们需要自己做很多很多的工作，完成起来是比较复杂的。</p>
<p>为了简化使用，Langchain4j提供了AiService工具类，封装了有关model对象和其他一些功能的操作。这里以spring集成langchain4j为例来介绍。</p>
<h4 id="基本使用"><a href="#基本使用" class="headerlink" title="基本使用"></a>基本使用</h4><h5 id="引入依赖"><a href="#引入依赖" class="headerlink" title="引入依赖"></a>引入依赖</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--   AiService相关依赖     --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>dev.langchain4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>langchain4j-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.1-beta6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="声明用于封装聊天方法的接口"><a href="#声明用于封装聊天方法的接口" class="headerlink" title="声明用于封装聊天方法的接口"></a>声明用于封装聊天方法的接口</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ChatService</span> &#123;</span><br><span class="line">    <span class="comment">//用于聊天的方法，message为用户输入的内容</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">chat</span><span class="params">(String message)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="使用AiService工具类创建接口的动态代理对象"><a href="#使用AiService工具类创建接口的动态代理对象" class="headerlink" title="使用AiService工具类创建接口的动态代理对象"></a>使用AiService工具类创建接口的动态代理对象</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    OpenAiChatModel model;</span><br><span class="line">    <span class="meta">@Bean</span> <span class="comment">//注册到Spring容器中</span></span><br><span class="line">    <span class="keyword">public</span> ChatService <span class="title function_">chatService</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> AiServices.builder(ChatService.class)</span><br><span class="line">                .chatModel(model) <span class="comment">//设置对话时使用的模型对象</span></span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="注入Controller并使用"><a href="#注入Controller并使用" class="headerlink" title="注入Controller并使用"></a>注入Controller并使用</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;chat&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ChatController</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    ChatService chatService;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/get&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getChat</span><span class="params">(String msg)</span>&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">chat</span> <span class="operator">=</span> chatService.chat(msg);</span><br><span class="line">        <span class="keyword">return</span> chat;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="测试结果-2"><a href="#测试结果-2" class="headerlink" title="测试结果"></a>测试结果</h5><p><img src="/images/image-20250824202309660.png" alt="image-20250824202309660"></p>
<h5 id="原理介绍"><a href="#原理介绍" class="headerlink" title="原理介绍"></a>原理介绍</h5><p>当调用chatService.chat(msg)时，实际发生的过程是：</p>
<ol>
<li>Java动态代理拦截了这个方法调用</li>
<li>Langchain4j将方法名和参数转换为对AI模型的请求</li>
<li>根据配置，向DeepSeek API发送HTTP请求</li>
<li>接收并处理AI模型的响应</li>
<li>将响应结果作为方法返回值返回</li>
</ol>
<p>这种设计的优势在于，开发者只需要定义接口和方法，而不需要编写具体的实现代码，大大简化了与AI模型交互的复杂性。Langchain4j负责处理所有底层细节，包括HTTP通信、JSON序列化&#x2F;反序列化、错误处理等。</p>
<p>在单个参数的情况下，默认给大模型发送的是用户信息，如果是<strong>多个参数，则需要通过注解指定各个参数的作用</strong>。</p>
<h4 id="声明式使用"><a href="#声明式使用" class="headerlink" title="声明式使用"></a>声明式使用</h4><p>为了简化AIServices工具类的使用，LangChain4j提供了声明式使用方法，想为哪个接口创建代理对象，只需要在该接口上添加@AiService注解并指定要使用的模型，将来LangChain4j扫描到该注解后会自动的创建该接口的代理对象并注入到IOC容器中，这样子就不需要我们手动在配置类中创建Bean对象了。接下来修改ConsultantService中的代码，并重新测试。</p>
<h5 id="接口配置"><a href="#接口配置" class="headerlink" title="接口配置"></a>接口配置</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@AiService(</span></span><br><span class="line"><span class="meta">        wiringMode = AiServiceWiringMode.EXPLICIT, //装配模式，手动</span></span><br><span class="line"><span class="meta">        chatModel = &quot;openAiChatModel&quot; //要使用的模型在容器中的bean名称</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ChatService</span> &#123;</span><br><span class="line">    <span class="comment">//用于聊天的方法，message为用户输入的内容</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">chat</span><span class="params">(String message)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在Langchain4j中，@AiService注解的wiringMode参数用于指定AI服务组件的装配模式。它有两个可选值：</p>
<p>1.AUTOMATIC（自动装配模式）</p>
<p>这是默认模式，不需要显式指定组件。Langchain4j会自动从Spring应用上下文中查找并装配所有可用的Langchain4j组件，包括：</p>
<ol>
<li>ChatModel</li>
<li>StreamingChatLanguageModel</li>
<li>ChatMemory</li>
<li>ChatMemoryProvider</li>
<li>ContentRetriever</li>
<li>RetrievalAugmentor</li>
<li>所有标记为@Tool的方法</li>
</ol>
<p>2.EXPLICIT（显式装配模式）</p>
<p>当应用中有多个AI服务，并且希望为每个服务指定不同的Langchain4j组件时，就需要使用显式装配模式。</p>
<h3 id="2-流式调用"><a href="#2-流式调用" class="headerlink" title="2.流式调用"></a>2.流式调用</h3><h4 id="引入依赖-1"><a href="#引入依赖-1" class="headerlink" title="引入依赖"></a>引入依赖</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--  引入流式调用的相关依赖      --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-webflux<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>dev.langchain4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>langchain4j-reactor<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.1-beta6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="配置流式模型对象"><a href="#配置流式模型对象" class="headerlink" title="配置流式模型对象"></a>配置流式模型对象</h4><p>之前使用的是阻塞式对话模型对象，在流式调用中，需要使用流式模型对象，故也需要进行配置</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">langchain4j:</span></span><br><span class="line">  <span class="attr">open-ai:</span></span><br><span class="line">    <span class="attr">streaming-chat-model:</span> <span class="comment"># 流式模型对象</span></span><br><span class="line">      <span class="attr">base-url:</span> <span class="string">https://api.deepseek.com</span></span><br><span class="line">      <span class="attr">model-name:</span> <span class="string">deepseek-chat</span></span><br><span class="line">      <span class="attr">api-key:</span> <span class="string">自己的apikey</span></span><br><span class="line">      <span class="attr">log-requests:</span> <span class="literal">true</span>   <span class="comment"># 打印请求日志</span></span><br><span class="line">      <span class="attr">log-responses:</span> <span class="literal">true</span>   <span class="comment"># 打印响应日志</span></span><br></pre></td></tr></table></figure>

<h4 id="在接口中配置流式模型对象"><a href="#在接口中配置流式模型对象" class="headerlink" title="在接口中配置流式模型对象"></a>在接口中配置流式模型对象</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@AiService(</span></span><br><span class="line"><span class="meta">        wiringMode = AiServiceWiringMode.EXPLICIT, //</span></span><br><span class="line"><span class="meta">        chatModel = &quot;openAiChatModel&quot;, //阻塞式模型，模型在容器中的bean名称</span></span><br><span class="line"><span class="meta">        streamingChatModel = &quot;openAiStreamingChatModel&quot;//流式模型</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ChatService</span> &#123;</span><br><span class="line">    <span class="comment">//用于聊天的方法，message为用户输入的内容</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">chat</span><span class="params">(String message)</span>;</span><br><span class="line">    <span class="comment">//流式返回</span></span><br><span class="line">    <span class="keyword">public</span> Flux&lt;String&gt; <span class="title function_">fluxChat</span><span class="params">(String msg)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>langchain4j中，会根据方法的返回值来自动选择使用哪个模型</p>
<p>同步返回类型（String、Response等）→ 使用chatModel</p>
<p>流式返回类型（Flux、Publisher等）→ 使用streamingChatModel</p>
<h4 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/flux&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Flux&lt;String&gt; <span class="title function_">getFlux</span><span class="params">(String msg)</span>&#123;</span><br><span class="line">    Flux&lt;String&gt; res = chatService.fluxChat(msg);</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/images/image-20250824204847416.png" alt="image-20250824204847416"></p>
<p>可以看到，浏览器返回了乱码</p>
<h4 id="问题原因"><a href="#问题原因" class="headerlink" title="问题原因"></a>问题原因</h4><p>在访问String的get接口时，响应标头携带了utf-8的编码格式，</p>
<p><img src="/images/image-20250824210558957.png" alt="image-20250824210558957"></p>
<p>但在flux接口却没有携带</p>
<p><img src="/images/image-20250824210918937.png" alt="image-20250824210918937"></p>
<p>乱码产生原因还是编码和解码不匹配的问题：</p>
<p>SpringBoot默认使用utf-8进行编码，并在响应头中告诉浏览器编码方式为utf-8。但在流式响应中，没有告诉浏览器编码方式为utf-8,导致浏览器使用默认的解码方式（非utf-8）进行解码，导致乱码问题产生。</p>
<h4 id="解决乱码问题"><a href="#解决乱码问题" class="headerlink" title="解决乱码问题"></a>解决乱码问题</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(value=&quot;/flux&quot;, produces = &quot;text/html;charset=utf-8&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Flux&lt;String&gt; <span class="title function_">getFlux</span><span class="params">(String msg)</span>&#123;</span><br><span class="line">    Flux&lt;String&gt; res = chatService.fluxChat(msg);</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>produces参数作用：</p>
<p>1.决定请求能不能匹配到这个接口，即判断前端的Accept头里声明的能接收的媒体类型是否符合  </p>
<p>2.返回响应时，在响应头中的Content-Type中设置为<code>text/html;charset=指定编码格式</code></p>
<h3 id="3-消息注解"><a href="#3-消息注解" class="headerlink" title="3.消息注解"></a>3.消息注解</h3><p>在langchain4j中提供了两个有关消息的注解，一个是SystemMessage,另一个是UserMessage。</p>
<h4 id="SystemMessage"><a href="#SystemMessage" class="headerlink" title="SystemMessage"></a>SystemMessage</h4><p>SystemMessage用于设置系统消息，可以直接在接口方法中添加这个注解，然后在注解中添加指定的系统消息即可。如果说消息很长，写在代码中不方便，也可以通过fromResource属性指定外部的文件，这样子可以一次性把系统消息写入到外部文件中，管理起来也很方便。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//    @SystemMessage(&quot;你是高考志愿填报者,禁止回答与高考志愿无关的问题&quot;)</span></span><br><span class="line"><span class="meta">@SystemMessage(fromResource = &quot;system.txt&quot;)</span> <span class="comment">//访问位置：resource文件下的system.txt文件</span></span><br><span class="line"><span class="keyword">public</span> Flux&lt;String&gt; <span class="title function_">fluxChat</span><span class="params">(String msg)</span>;</span><br></pre></td></tr></table></figure>

<h4 id="UserMessage"><a href="#UserMessage" class="headerlink" title="UserMessage"></a>UserMessage</h4><p>@UserMessage可以帮助我们把用户传递的消息拼接上我们预设的消息，使用方式如下，注意使用<code>&#123;&#123;&#125;&#125;</code>和@V注解进行绑定。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//一个参数情况</span></span><br><span class="line"><span class="meta">@SystemMessage(fromResource = &quot;system.txt&quot;)</span></span><br><span class="line"><span class="meta">@UserMessage(&quot;您好，我有个志愿填报问题：&#123;&#123;it&#125;&#125;&quot;)</span> <span class="comment">//只有一个参数情况下默认使用msg进行拼接</span></span><br><span class="line"><span class="keyword">public</span> Flux&lt;String&gt; <span class="title function_">fluxChat</span><span class="params">(String msg)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//多个参数情况</span></span><br><span class="line"><span class="meta">@UserMessage(&quot;您好，我是&#123;&#123;name&#125;&#125;, 想请教您：&#123;&#123;msg&#125;&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">chat2</span><span class="params">(<span class="meta">@V(&quot;name&quot;)</span> String msg1, <span class="meta">@V(&quot;msg&quot;)</span> String msg2)</span>;</span><br></pre></td></tr></table></figure>

<p>这里有一点需要说明，在没有@V情况下，这个花括号内的it是固定的，不能随便写（写了别的就会报异常）。假设你不想使用it这个名字，langchain4j提供了一个V注解，用于解决这个问题。我们在参数前面通过V注解给这个参数起一个名字，然后在花括号内写上同样的名字就能获取到了。</p>
<p><img src="/images/image-20250824215038830.png" alt="image-20250824215038830"></p>
<h4 id="测试-1"><a href="#测试-1" class="headerlink" title="测试"></a>测试</h4><p>以上面的接口配置为准，单参测试</p>
<p><img src="/images/image-20250824215204856.png" alt="image-20250824215204856"></p>
<p>多参测试</p>
<p><img src="/images/image-20250824215459088.png" alt="image-20250824215459088"></p>
<h3 id="4-会话记忆"><a href="#4-会话记忆" class="headerlink" title="4.会话记忆"></a>4.会话记忆</h3><p>大模型是如何记住我们之前的问题的，来回答后续的问题的呢？答案就是<strong>在当前问题发送的同时，将之前的问题和回答一并发送了过去</strong>！！！这就是会话记忆的实现方式。</p>
<h4 id="实现原理"><a href="#实现原理" class="headerlink" title="实现原理"></a>实现原理</h4><p>来源：<a target="_blank" rel="noopener" href="https://fhg2d1ub6i.feishu.cn/docx/X2o7dVT0XoszQvxFKUCcHv78nVg">第三章：LangChain4j - 飞书云文档</a></p>
<p><img src="/images/eed7834f-484d-415f-944e-c16ad2de95c6.gif" alt="eed7834f-484d-415f-944e-c16ad2de95c6"></p>
<p>当用户问西北大学是211吗？它会把消息传递给后端，后端接收到消息后，会自动把消息存放到存储对象中，然后再获取存储对象中记录的所有会话消息，一块发送给大模型，当然现在存储对象中只记录了一条消息，所以只把一条消息发送给大模型。大模型根据接收到的消息，生成答案，比如说是的，再把答案响应给web后端，此时web后端会把得到的响应消息往存储对象中拷贝一份，然后再把响应消息发送给用户。</p>
<p>用户接收到答案后，接着问,是985吗？这条消息发送给web后端后，web后端依然会自动的把消息存放到存储对象中，此时存储对象中就存放了三条消息了，紧接着获取到存储对象中所有的会话消息，一并发送给大模型，这一次大模型就能够根据用户发送的所有会话记录进行推断回答了，这就是会话记忆的原理！</p>
<h4 id="基本实现"><a href="#基本实现" class="headerlink" title="基本实现"></a>基本实现</h4><p>langchain4j提供了一个接口叫做<strong>ChatMemory</strong>，该接口中提供了add方法用于添加一条记录，messages方法用于获取所有的会话记录，clear方法用于清除所有的会话记录，这里还有一个id方法，它是用于唯一的标识一个存储对象。</p>
<h5 id="定义会话记忆对象"><a href="#定义会话记忆对象" class="headerlink" title="定义会话记忆对象"></a>定义会话记忆对象</h5><p>在配置类中创建ChatMemory的实现类并注册到IOC容器中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line">ChatMemory <span class="title function_">chatMemory</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> MessageWindowChatMemory.builder()</span><br><span class="line">            .maxMessages(<span class="number">20</span>) <span class="comment">//最大的会话数量</span></span><br><span class="line">            .build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="配置会话记忆对象"><a href="#配置会话记忆对象" class="headerlink" title="配置会话记忆对象"></a>配置会话记忆对象</h5><p>配置到AiService中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@AiService(</span></span><br><span class="line"><span class="meta">        wiringMode = AiServiceWiringMode.EXPLICIT, //</span></span><br><span class="line"><span class="meta">        chatModel = &quot;openAiChatModel&quot;, //阻塞式模型，模型在容器中的bean名称</span></span><br><span class="line"><span class="meta">        streamingChatModel = &quot;openAiStreamingChatModel&quot;,//流式模型</span></span><br><span class="line"><span class="meta">        chatMemory = &quot;chatMemory&quot; //配置会话记忆对象，填入bean名称</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ChatService</span> &#123;</span><br><span class="line">    <span class="comment">//略</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="会话记忆隔离"><a href="#会话记忆隔离" class="headerlink" title="会话记忆隔离"></a>会话记忆隔离</h4><p>上述的配置和实现并没有区分访问的用户对象，导致不同用户会共用同一个会话记忆对象。</p>
<p>要实现会话记忆隔离，就要使用唯一标识(id)来标记会话记忆对象。</p>
<p><img src="/images/ff0f319e-422b-43fd-b3a7-1cd1cb596a58.gif" alt="ff0f319e-422b-43fd-b3a7-1cd1cb596a58"></p>
<p>在LangChain4j中可以准备一个容器，专门用于存储当前程序中所有的会话记忆对象。假设有一个用户访问我们的程序，此时它除了要把用户问题message携带给后端，还需要携带一个memoryId，假设它携带的memoryId为1，此时LangChain4j会先从容器中找有没有一个ChatMemory对象的id为1，如果有就使用，但是很明显现在没有。所以它会新创建一个ChatMemory对象，并把当前的memoryId  1  设置给这个ChatMemory对象，并把会话记录存储到该对象中使用。</p>
<p>假设又有一个用户访问我们的程序，它携带的memoryId为2，同样的，LangChain4j也会从容器中找有没有一个ChatMemory对象的id为2，很显然还是没有，所以会创建一个新的ChatMemory对象，并把memoryId 2设置给这个ChatMemory对象，并把会话记录存储到该对象中使用。</p>
<p>注意，假设第二个用户继续访问我们的程序，它携带了同样的memoryId 2给后端，此时LangChain4j从容器中查找的时候发现已经存在一个ChatMemory对象的id为2，所以直接复用这个已经存在的ChatMemory对象，这样我们就可以借助于ChatMemory的id值实现不同会话之间的记忆隔离效果。</p>
<h5 id="定义会话记忆对象提供者"><a href="#定义会话记忆对象提供者" class="headerlink" title="定义会话记忆对象提供者"></a>定义会话记忆对象提供者</h5><p>因为要区分不同的会话对象，所以需要创建一个能根据传入的id创建不同ChatMemory的对象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line">ChatMemoryProvider <span class="title function_">chatMemoryProvider</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ChatMemoryProvider</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> ChatMemory <span class="title function_">get</span><span class="params">(Object memoryId)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> MessageWindowChatMemory.builder()</span><br><span class="line">                    .id(memoryId)</span><br><span class="line">                    .maxMessages(<span class="number">20</span>)</span><br><span class="line">                    .build();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="配置会话记忆对象提供者"><a href="#配置会话记忆对象提供者" class="headerlink" title="配置会话记忆对象提供者"></a>配置会话记忆对象提供者</h5><p>这里原先的charMemory就不需要了，因为它仅仅是固定一个对象，而我们需要的是根据id的不同创建能新的chatMemory对象的提供者来获取或者创建chatMemory。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@AiService(</span></span><br><span class="line"><span class="meta">        wiringMode = AiServiceWiringMode.EXPLICIT, //</span></span><br><span class="line"><span class="meta">        chatModel = &quot;openAiChatModel&quot;, //阻塞式模型，模型在容器中的bean名称</span></span><br><span class="line"><span class="meta">        streamingChatModel = &quot;openAiStreamingChatModel&quot;,//流式模型</span></span><br><span class="line"><span class="meta">        //chatMemory = &quot;chatMemory&quot;, //会话记忆对象</span></span><br><span class="line"><span class="meta">        chatMemoryProvider = &quot;charMemoryProvider&quot; //会话记忆对象提供者</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ChatService</span> &#123;</span><br><span class="line">    <span class="comment">//略</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="接口添加MemoryId参数"><a href="#接口添加MemoryId参数" class="headerlink" title="接口添加MemoryId参数"></a>接口添加MemoryId参数</h5><p>使用@MemoryId注解</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SystemMessage(fromResource = &quot;system.txt&quot;)</span></span><br><span class="line"><span class="meta">@UserMessage(&quot;您好，我有个志愿填报问题：&#123;&#123;it&#125;&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Flux&lt;String&gt; <span class="title function_">fluxChat</span><span class="params">(<span class="meta">@MemoryId</span> String memoryId, <span class="meta">@V(&quot;it&quot;)</span> String msg)</span>;</span><br></pre></td></tr></table></figure>

<h5 id="Controller添加MemoryId参数"><a href="#Controller添加MemoryId参数" class="headerlink" title="Controller添加MemoryId参数"></a>Controller添加MemoryId参数</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(value=&quot;/flux&quot;, produces = &quot;text/html;charset=utf-8&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Flux&lt;String&gt; <span class="title function_">getFlux</span><span class="params">(String memoryId, String msg)</span>&#123;</span><br><span class="line">    Flux&lt;String&gt; res = chatService.fluxChat(memoryId, msg);</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="测试-2"><a href="#测试-2" class="headerlink" title="测试"></a>测试</h5><p>memoryId&#x3D;1时测试</p>
<p><img src="/images/image-20250824223413311.png" alt="image-20250824223413311"></p>
<p><img src="/images/image-20250824223539038.png" alt="image-20250824223539038"></p>
<p>memory&#x3D;2继续测试</p>
<p><img src="/images/image-20250824223628874.png" alt="image-20250824223628874"></p>
<h5 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h5><p>配置提供者后，是如何判断id对应的会话对象是否已经存在的？</p>
<ol>
<li>核心概念澄清<br>  首先需要澄清一个概念：ChatMemoryProvider本身并不判断ID是否存在，它只是根据ID返回ChatMemory实例。真正存储会话ID和消息列表的是底层的ChatMemoryStore。它可以在build ChatMemory时进行指定，跟后面讲的持久化相关。</li>
</ol>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line">ChatMemoryProvider <span class="title function_">chatMemoryProvider</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ChatMemoryProvider</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> ChatMemory <span class="title function_">get</span><span class="params">(Object id)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> MessageWindowChatMemory.builder()</span><br><span class="line">                    .id(id)</span><br><span class="line">                    .chatMemoryStore(myChatMemoryStore)  <span class="comment">// 关键在这里</span></span><br><span class="line">                    .maxMessages(<span class="number">20</span>)</span><br><span class="line">                    .build();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>源码解读</li>
</ol>
<p>ChatMemory的实现类MessageWindowChatMemory的部分源码+解读</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MessageWindowChatMemory</span> <span class="keyword">implements</span> <span class="title class_">ChatMemory</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object id;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Integer maxMessages;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ChatMemoryStore store; <span class="comment">//真正存储会话记录的对象</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//设置会话ID</span></span><br><span class="line">    <span class="keyword">public</span> Builder <span class="title function_">id</span><span class="params">(Object id)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.id = id;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">	<span class="comment">//添加新消息到对应的store中</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">add</span><span class="params">(ChatMessage message)</span> &#123;</span><br><span class="line">        <span class="comment">//获取历史消息</span></span><br><span class="line">        List&lt;ChatMessage&gt; messages = <span class="built_in">this</span>.messages();</span><br><span class="line">        <span class="keyword">if</span> (message <span class="keyword">instanceof</span> SystemMessage) &#123;</span><br><span class="line">            Optional&lt;SystemMessage&gt; systemMessage = findSystemMessage(messages);</span><br><span class="line">            <span class="keyword">if</span> (systemMessage.isPresent()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (((SystemMessage)systemMessage.get()).equals(message)) &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                messages.remove(systemMessage.get());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//历史消息拼接上新的消息</span></span><br><span class="line">        messages.add(message);</span><br><span class="line">        <span class="comment">//判断消息容量</span></span><br><span class="line">        ensureCapacity(messages, <span class="built_in">this</span>.maxMessages);</span><br><span class="line">        <span class="comment">//根据消息id,更新store的map对应的消息列表</span></span><br><span class="line">        <span class="built_in">this</span>.store.updateMessages(<span class="built_in">this</span>.id, messages);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> List&lt;ChatMessage&gt; <span class="title function_">messages</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//从sotre中获取会话列表</span></span><br><span class="line">        List&lt;ChatMessage&gt; messages = <span class="keyword">new</span> <span class="title class_">LinkedList</span>(<span class="built_in">this</span>.store.getMessages(<span class="built_in">this</span>.id));</span><br><span class="line">        ensureCapacity(messages, <span class="built_in">this</span>.maxMessages);</span><br><span class="line">        <span class="keyword">return</span> messages;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ChatMemoryStore的实现类InMemoryChatMemoryStore解读</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//可以看到ChatMemoryStore并没有任何存储对象的方式，所以InMemoryChatMemoryStore的Map只是存储会话记录的一种方式，其他方法也可以使用的，具体怎么存储，还是看自己的实现</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ChatMemoryStore</span> &#123;</span><br><span class="line">    List&lt;ChatMessage&gt; <span class="title function_">getMessages</span><span class="params">(Object var1)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">updateMessages</span><span class="params">(Object var1, List&lt;ChatMessage&gt; var2)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">deleteMessages</span><span class="params">(Object var1)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//实现类</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InMemoryChatMemoryStore</span> <span class="keyword">implements</span> <span class="title class_">ChatMemoryStore</span> &#123;</span><br><span class="line">    <span class="comment">//维护了一个以memoryId为key,消息列表为value的Map对象</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Object, List&lt;ChatMessage&gt;&gt; messagesByMemoryId = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">InMemoryChatMemoryStore</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> List&lt;ChatMessage&gt; <span class="title function_">getMessages</span><span class="params">(Object memoryId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (List)<span class="built_in">this</span>.messagesByMemoryId.computeIfAbsent(memoryId, (ignored) -&gt; &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ArrayList</span>();</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">//根据会话id，直接把消息列表进行put</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateMessages</span><span class="params">(Object memoryId, List&lt;ChatMessage&gt; messages)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.messagesByMemoryId.put(memoryId, messages);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deleteMessages</span><span class="params">(Object memoryId)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.messagesByMemoryId.remove(memoryId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从源码中可以知道，当一个用户传入会话id和会话时，会先根据id创建一个新的ChatMemory对象，然后，再调用add方法传入用户当前的消息，在add方法中，它会往它关联的store对象中先读取历史会话列表，在把当前消息添加到列表末尾，最后调用Store对象的updateMessages方法，对InMemoryChatMemoryStore对象维护的Map中，根据会话ID，进行会话列表的更新。</p>
<p>所以，简单来说，真正存储会话id和会话列表的是ChatMemoryStore对象，ChatMemory对象只是用来操作Store对象的，并不存储消息，Provider对象只是用来创建ChatMemory对象的。</p>
<p>ok,完成了上面的源码解读还是挺爽的。</p>
<h4 id="会话记忆持久化"><a href="#会话记忆持久化" class="headerlink" title="会话记忆持久化"></a>会话记忆持久化</h4><p>上面我们已经知道了ChatMemoryStore是如何存储会话记录的，那么问题来了，如果使用已有的ChatMemoryStore实现类，那么当服务器重启时，数据就会丢失，所以我们需要自己去创建ChatMemoryStore的实现，来实现用中间件，比如用redis持久化存储消息。</p>
<p>下面就使用redis来实现会话的持久化存储</p>
<h5 id="引入依赖-2"><a href="#引入依赖-2" class="headerlink" title="引入依赖"></a>引入依赖</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="配置redis连接信息"><a href="#配置redis连接信息" class="headerlink" title="配置redis连接信息"></a>配置redis连接信息</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">data:</span></span><br><span class="line">    <span class="attr">redis:</span></span><br><span class="line">      <span class="attr">host:</span> <span class="string">自己的redis的ip地址</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">6379</span></span><br></pre></td></tr></table></figure>

<h5 id="自定义ChatMemoryStore对象的实现类"><a href="#自定义ChatMemoryStore对象的实现类" class="headerlink" title="自定义ChatMemoryStore对象的实现类"></a>自定义ChatMemoryStore对象的实现类</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisChatMemoryStore</span> <span class="keyword">implements</span> <span class="title class_">ChatMemoryStore</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    StringRedisTemplate template;</span><br><span class="line">    <span class="comment">//会话记录的key前缀</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">prefix</span> <span class="operator">=</span> <span class="string">&quot;chat_memoryId_&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;ChatMessage&gt; <span class="title function_">getMessages</span><span class="params">(Object o)</span> &#123;</span><br><span class="line">        <span class="comment">//获取存储在redis中的序列化后的json数据</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> template.opsForValue().get(prefix + o);</span><br><span class="line">        <span class="comment">//对message反序列化为会话列表</span></span><br><span class="line">        List&lt;ChatMessage&gt; chatMessages = ChatMessageDeserializer.messagesFromJson(message);</span><br><span class="line">        <span class="keyword">return</span> chatMessages;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateMessages</span><span class="params">(Object o, List&lt;ChatMessage&gt; list)</span> &#123;</span><br><span class="line">        <span class="comment">//对会话列表序列化为json字符串</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> ChatMessageSerializer.messagesToJson(list);</span><br><span class="line">        <span class="comment">//更新会话列表</span></span><br><span class="line">        template.opsForValue().set(prefix+o, message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deleteMessages</span><span class="params">(Object o)</span> &#123;</span><br><span class="line">        <span class="comment">//删除会话记录</span></span><br><span class="line">        template.delete(prefix + o);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意，这里使用了ChatMessageSerializer和ChatMessageDeserializer提供的序列化和反序列化方法。</p>
<h5 id="在ChatMemoryProvider中配置自定义实现类"><a href="#在ChatMemoryProvider中配置自定义实现类" class="headerlink" title="在ChatMemoryProvider中配置自定义实现类"></a>在ChatMemoryProvider中配置自定义实现类</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    OpenAiChatModel model;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    RedisChatMemoryStore redisChatMemoryStore;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//会话记忆对象提供者</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    ChatMemoryProvider <span class="title function_">chatMemoryProvider</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">ChatMemoryProvider</span> <span class="variable">chatMemoryProvider</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChatMemoryProvider</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> ChatMemory <span class="title function_">get</span><span class="params">(Object o)</span> &#123;</span><br><span class="line">                ;<span class="keyword">return</span> MessageWindowChatMemory.builder()</span><br><span class="line">                        .id(o)</span><br><span class="line">                        .chatMemoryStore(redisChatMemoryStore) <span class="comment">//使用自定义会话存储对象</span></span><br><span class="line">                        .maxMessages(<span class="number">20</span>)</span><br><span class="line">                        .build();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">return</span> chatMemoryProvider;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="测试-3"><a href="#测试-3" class="headerlink" title="测试"></a>测试</h5><p>完美存储到redis中，测试时我注意到消息的存储流程正是，用户发送消息 -&gt; 消息存储到redis -&gt; 发送消息给大模型 -&gt; 大模型生成回答 -&gt; 回答存入redis -&gt; 返回给前端</p>
<p><img src="/images/image-20250824234216377.png" alt="image-20250824234216377"></p>
<h5 id="感想"><a href="#感想" class="headerlink" title="感想"></a>感想</h5><p>会话记忆中的主要的三个接口设置的实在是太妙了，由ChatMemoryStore负责会话记录的增删改，ChatMemory负责消息的业务逻辑操作，比如拼接会话记录并存入到store对象中，ChatMemoryProvider则类似于工厂，提供ChatMemory对象的实例。极大程度上进行了解耦，方便扩展。</p>
<p>职责分离 (Separation of Concerns)</p>
<ul>
<li>ChatMemoryStore: 专注于数据的持久化和检索</li>
<li>ChatMemory: 专注于消息的处理和操作</li>
<li>ChatMemoryProvider: 专注于实例的创建和管理</li>
</ul>
<p>高内聚低耦合 (High Cohesion, Low Coupling)</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="http://example.com">ldy</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2025/08/24/Langchain4j%E5%AD%A6%E4%B9%A0/">http://example.com/2025/08/24/Langchain4j%E5%AD%A6%E4%B9%A0/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">Journey</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E5%A4%A7%E6%A8%A1%E5%9E%8B/">大模型</a></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/qcqwy/blog-img@main/img/poke1.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="next-post pull-full"><a href="/2025/08/18/%E9%9D%A2%E7%BB%8F%E6%94%B6%E9%9B%86/" title="面经收集"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">面经收集</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://cdn.jsdelivr.net/gh/qcqwy/blog-img@main/img/poke1.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">ldy</div><div class="author-info__description">I am a slow walker,but I never walk backwards.我走得很慢，但是我从来不会后退</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">35</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">26</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">10</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/qcqwy"><i class="fab fa-github"></i><span>别点这里</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8"><span class="toc-text">一、快速入门</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%99%AE%E9%80%9Amaven%E9%A1%B9%E7%9B%AE"><span class="toc-text">普通maven项目</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E5%88%9B%E5%BB%BAmaven%E5%B7%A5%E7%A8%8B"><span class="toc-text">1.创建maven工程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E5%BC%95%E5%85%A5%E4%BE%9D%E8%B5%96"><span class="toc-text">2.引入依赖</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E6%9E%84%E5%BB%BA%E8%81%8A%E5%A4%A9%E5%AF%B9%E8%B1%A1OpenAiChatModel"><span class="toc-text">3.构建聊天对象OpenAiChatModel</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E7%BB%93%E6%9E%9C"><span class="toc-text">测试结果</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Spring%E6%95%B4%E5%90%88Langchain4j"><span class="toc-text">Spring整合Langchain4j</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E6%A0%B8%E5%BF%83%E4%BE%9D%E8%B5%96"><span class="toc-text">1.核心依赖</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E5%9C%A8%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E4%B8%AD%E9%85%8D%E7%BD%AE%E5%A4%A7%E6%A8%A1%E5%9E%8B%E4%BF%A1%E6%81%AF"><span class="toc-text">2.在配置文件中配置大模型信息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E5%88%9B%E5%BB%BAController%E8%B0%83%E7%94%A8%E6%8E%A5%E5%8F%A3"><span class="toc-text">3.创建Controller调用接口</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E7%BB%93%E6%9E%9C-1"><span class="toc-text">测试结果</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E8%BF%9B%E9%98%B6%E7%AF%87"><span class="toc-text">二、进阶篇</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-AiService%E5%B7%A5%E5%85%B7%E7%B1%BB"><span class="toc-text">1.AiService工具类</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8"><span class="toc-text">基本使用</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BC%95%E5%85%A5%E4%BE%9D%E8%B5%96"><span class="toc-text">引入依赖</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%A3%B0%E6%98%8E%E7%94%A8%E4%BA%8E%E5%B0%81%E8%A3%85%E8%81%8A%E5%A4%A9%E6%96%B9%E6%B3%95%E7%9A%84%E6%8E%A5%E5%8F%A3"><span class="toc-text">声明用于封装聊天方法的接口</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8AiService%E5%B7%A5%E5%85%B7%E7%B1%BB%E5%88%9B%E5%BB%BA%E6%8E%A5%E5%8F%A3%E7%9A%84%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E5%AF%B9%E8%B1%A1"><span class="toc-text">使用AiService工具类创建接口的动态代理对象</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B3%A8%E5%85%A5Controller%E5%B9%B6%E4%BD%BF%E7%94%A8"><span class="toc-text">注入Controller并使用</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E7%BB%93%E6%9E%9C-2"><span class="toc-text">测试结果</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8E%9F%E7%90%86%E4%BB%8B%E7%BB%8D"><span class="toc-text">原理介绍</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A3%B0%E6%98%8E%E5%BC%8F%E4%BD%BF%E7%94%A8"><span class="toc-text">声明式使用</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E9%85%8D%E7%BD%AE"><span class="toc-text">接口配置</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E6%B5%81%E5%BC%8F%E8%B0%83%E7%94%A8"><span class="toc-text">2.流式调用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%95%E5%85%A5%E4%BE%9D%E8%B5%96-1"><span class="toc-text">引入依赖</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%B5%81%E5%BC%8F%E6%A8%A1%E5%9E%8B%E5%AF%B9%E8%B1%A1"><span class="toc-text">配置流式模型对象</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9C%A8%E6%8E%A5%E5%8F%A3%E4%B8%AD%E9%85%8D%E7%BD%AE%E6%B5%81%E5%BC%8F%E6%A8%A1%E5%9E%8B%E5%AF%B9%E8%B1%A1"><span class="toc-text">在接口中配置流式模型对象</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95"><span class="toc-text">测试</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E5%8E%9F%E5%9B%A0"><span class="toc-text">问题原因</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E4%B9%B1%E7%A0%81%E9%97%AE%E9%A2%98"><span class="toc-text">解决乱码问题</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E6%B6%88%E6%81%AF%E6%B3%A8%E8%A7%A3"><span class="toc-text">3.消息注解</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#SystemMessage"><span class="toc-text">SystemMessage</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#UserMessage"><span class="toc-text">UserMessage</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95-1"><span class="toc-text">测试</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E4%BC%9A%E8%AF%9D%E8%AE%B0%E5%BF%86"><span class="toc-text">4.会话记忆</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86"><span class="toc-text">实现原理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E5%AE%9E%E7%8E%B0"><span class="toc-text">基本实现</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89%E4%BC%9A%E8%AF%9D%E8%AE%B0%E5%BF%86%E5%AF%B9%E8%B1%A1"><span class="toc-text">定义会话记忆对象</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E4%BC%9A%E8%AF%9D%E8%AE%B0%E5%BF%86%E5%AF%B9%E8%B1%A1"><span class="toc-text">配置会话记忆对象</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BC%9A%E8%AF%9D%E8%AE%B0%E5%BF%86%E9%9A%94%E7%A6%BB"><span class="toc-text">会话记忆隔离</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89%E4%BC%9A%E8%AF%9D%E8%AE%B0%E5%BF%86%E5%AF%B9%E8%B1%A1%E6%8F%90%E4%BE%9B%E8%80%85"><span class="toc-text">定义会话记忆对象提供者</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E4%BC%9A%E8%AF%9D%E8%AE%B0%E5%BF%86%E5%AF%B9%E8%B1%A1%E6%8F%90%E4%BE%9B%E8%80%85"><span class="toc-text">配置会话记忆对象提供者</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E6%B7%BB%E5%8A%A0MemoryId%E5%8F%82%E6%95%B0"><span class="toc-text">接口添加MemoryId参数</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Controller%E6%B7%BB%E5%8A%A0MemoryId%E5%8F%82%E6%95%B0"><span class="toc-text">Controller添加MemoryId参数</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95-2"><span class="toc-text">测试</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%97%AE%E9%A2%98"><span class="toc-text">问题</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BC%9A%E8%AF%9D%E8%AE%B0%E5%BF%86%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-text">会话记忆持久化</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BC%95%E5%85%A5%E4%BE%9D%E8%B5%96-2"><span class="toc-text">引入依赖</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%85%8D%E7%BD%AEredis%E8%BF%9E%E6%8E%A5%E4%BF%A1%E6%81%AF"><span class="toc-text">配置redis连接信息</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89ChatMemoryStore%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%AE%9E%E7%8E%B0%E7%B1%BB"><span class="toc-text">自定义ChatMemoryStore对象的实现类</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9C%A8ChatMemoryProvider%E4%B8%AD%E9%85%8D%E7%BD%AE%E8%87%AA%E5%AE%9A%E4%B9%89%E5%AE%9E%E7%8E%B0%E7%B1%BB"><span class="toc-text">在ChatMemoryProvider中配置自定义实现类</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95-3"><span class="toc-text">测试</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%84%9F%E6%83%B3"><span class="toc-text">感想</span></a></li></ol></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/08/24/Langchain4j%E5%AD%A6%E4%B9%A0/" title="Langchain4j学习">Langchain4j学习</a><time datetime="2025-08-24T11:47:55.000Z" title="发表于 2025-08-24 19:47:55">2025-08-24</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/08/18/%E9%9D%A2%E7%BB%8F%E6%94%B6%E9%9B%86/" title="面经收集">面经收集</a><time datetime="2025-08-18T05:03:46.000Z" title="发表于 2025-08-18 13:03:46">2025-08-18</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/08/15/%E6%B7%B1%E5%85%A5java%E9%9B%86%E5%90%88/" title="深入java集合">深入java集合</a><time datetime="2025-08-15T09:57:34.000Z" title="发表于 2025-08-15 17:57:34">2025-08-15</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/07/11/%E5%BC%80%E5%8F%91%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E6%B1%87%E6%80%BB/" title="开发常见问题汇总">开发常见问题汇总</a><time datetime="2025-07-11T15:59:20.000Z" title="发表于 2025-07-11 23:59:20">2025-07-11</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/06/12/%E9%9D%A2%E7%BB%8F%E8%AE%B0%E5%BD%95/" title="面经记录">面经记录</a><time datetime="2025-06-12T12:49:19.000Z" title="发表于 2025-06-12 20:49:19">2025-06-12</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('https://t.alcy.cc/fj/')"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2025 By ldy</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=4.13.0"></script><script src="/js/main.js?v=4.13.0"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@5.2.0/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar@0.1.16/dist/snackbar.min.js"></script><div class="js-pjax"></div><script defer="defer" id="fluttering_ribbon" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/dist/canvas-fluttering-ribbon.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = true;
document.body.addEventListener('input', POWERMODE);
</script><script id="click-heart" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/dist/click-heart.min.js" async="async" mobile="false"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js?v=4.13.0"></script></div></div></body></html>